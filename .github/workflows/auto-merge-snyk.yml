name: Auto Merge Snyk PRs

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up GitHub CLI
        uses: actions/setup-node@v3
        with:
          node-version: "14"
      - run: npm install -g @octokit/graphql

      - name: Get PR info
        id: pr-info
        run: |
          gh pr view ${{ github.event.pull_request.number }} --json author,headRefName,labels -q '.author.login,.headRefName,.labels.[].name'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if PR is from Snyk
        id: check-snyk
        run: |
          if [[ "${{ steps.pr-info.outputs.headRefName }}" == snyk/* ]]; then
            echo "::set-output name=is_snyk::true"
          else
            echo "::set-output name=is_snyk::false"
          fi

      - name: Check if all checks passed
        id: check-passed
        run: |
          checks=$(gh pr checks ${{ github.event.pull_request.number }} --json status -q '.[] | select(.name == "continuous-integration" and .status != "success") | .name')
          if [[ -z "$checks" ]]; then
            echo "::set-output name=checks_passed::true"
          else
            echo "::set-output name=checks_passed::false"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Auto merge if conditions are met
        if: steps.check-snyk.outputs.is_snyk == 'true' && steps.check-passed.outputs.checks_passed == 'true'
        run: gh pr merge ${{ github.event.pull_request.number }} --merge
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
